# Stress mode analyses

## Dependencies and setup

```{r}
library(tidyverse)
library(cowplot)
library(RColorBrewer)
library(khroma)
library(rstatix)
library(knitr)
library(kableExtra)
library(viridis)
```

```{r}
# Build relative path from R's working directory to what is actually the working
# directory for this experiment.
experiment_slug <- "8-11-25-StressMode"
working_directory <- paste(
  "Analysis",
  experiment_slug,
  sep = "/"
)
```

```{r}
# Use the cowplot theme as our default for ggplots
theme_set(theme_cowplot())
# Create directory to save plots
plot_dir <- paste(
  working_directory,
  "plots",
  sep = "/"
)
dir.create(
  plot_dir,
  showWarnings = FALSE
)
```

### Load and preprocess data

```{r}
data_path <- paste(
  working_directory,
  "data",
  "munged_basic.dat",
  sep = "/"
)
data <- read_table(data_path)

task_completion_thresh <- 10

data <- data %>%
  mutate(
    treatment = as.factor(treatment),
    uid = as.factor(uid),
    task = factor(
      task,
      levels = c("NOT", "NAND", "AND", "ORN", "OR", "ANDN", "NOR", "XOR", "EQU")
    ),
    partner = as.factor(partner),
    task_completed = count > task_completion_thresh
  )
```

Separate out the final update data for convenience.

```{r}
final_update <- max(data$update)
final_data <- data %>% filter(update == final_update)
```

Summarize number of tasks marked as completed

```{r}
num_tasks_done_by_rep_final <- final_data %>%
  group_by(uid, partner, treatment, rep) %>%
  summarize(
    total_tasks = n(),
    tasks_completed = sum(task_completed == TRUE)
  )

num_tasks_done_by_rep_overtime <- data %>%
  group_by(uid, partner, treatment, rep, update) %>%
  summarize(
    total_tasks = n(),
    tasks_completed = sum(task_completed == TRUE)
  )

num_tasks_done_by_rep_alltime <- data %>%
  ungroup() %>%
  group_by(uid, partner, treatment, rep, task) %>%
  summarize(
    n = n(),
    task_completed_ever = any(task_completed)
  ) %>%
  ungroup() %>%
  group_by(uid, partner, treatment, rep) %>%
  summarize(
    n = n(),
    tasks_completed_ever = sum(task_completed_ever == TRUE)
  )
```

## Final task raw counts

### Hosts
```{r}
final_task_counts_hosts_plt <- ggplot(
  data = filter(final_data, partner == "Host"),
  aes(x = treatment, y = count, color = treatment)
) +
  geom_boxplot(
    alpha = 0.5,
    outlier.size = 1
  ) +
  scale_color_manual(
    name = "Treatment",
    values = viridis(4)
  ) +
  scale_x_discrete() +
  facet_wrap(~task, scales = "free") +
  labs(
    title = "Hosts",
    y = "Task Count - Final Update",
    x = "Treatment"
  ) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(
      angle = 30,
      hjust = 1
    )
  )

ggsave(
  file = paste(plot_dir, "final_task_counts_hosts.pdf", sep = "/"),
  plot = final_task_counts_hosts_plt
)
```

### Symbionts

```{r}
final_task_counts_sym_plt <- ggplot(
  data = filter(final_data, partner == "Symbiont"),
  aes(x = treatment, y = count, color = treatment)
) +
  geom_boxplot(
    alpha = 0.5,
    outlier.size = 1
  ) +
  scale_color_manual(
    name = "Treatment",
    values = viridis(4)
  ) +
  scale_x_discrete() +
  facet_wrap(~task, scales = "free") +
  labs(
    title = "Symbionts",
    y = "Task Count - Final Update",
    x = "Treatment"
  ) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(
      angle = 30,
      hjust = 1
    )
  )

ggsave(
  file = paste(plot_dir, "final_task_counts_sym.pdf", sep = "/"),
  plot = final_task_counts_sym_plt
)
```

## Final tasks completed by task

```{r}
tasks_completed <- final_data %>%
  group_by(partner, treatment, task) %>%
  summarize(
    total_reps = n(),
    tasks_completed = sum(task_completed == TRUE)
  )
```

### Hosts

```{r}
reps_with_task_hosts_plt <- ggplot(
  data = filter(tasks_completed, partner == "Host"),
  aes(x = treatment, y = tasks_completed, color = treatment, fill = treatment)
) +
  geom_col(
    alpha = 0.5
  ) +
  scale_color_manual(
    name = "Treatment",
    values = viridis(4)
  ) +
  scale_fill_manual(
    name = "Treatment",
    values = viridis(4)
  ) +
  scale_x_discrete() +
  scale_y_continuous(
    limits = c(0, 31)
  ) +
  facet_wrap(~task) +
  labs(
    title = "Hosts",
    y = "Replicates with task - Final Update",
    x = "Treatment"
  ) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(
      angle = 30,
      hjust = 1
    )
  )

ggsave(
  file = paste(plot_dir, "reps_with_task_hosts_plt.pdf", sep = "/"),
  plot = reps_with_task_hosts_plt
)
```

Run pairwise fisher's exact tests on each task

```{r}
tasks <- c("NOT", "NAND", "AND", "ORN", "OR", "ANDN", "NOR", "XOR", "EQU")
host_task_counts <- tasks_completed %>%
  ungroup() %>%
  filter(partner == "Host") %>%
  mutate(
    no_task_count = total_reps - tasks_completed
  )

fisher_results <- data.frame(
  task = character(),
  group1 = character(),
  group2 = character(),
  n = integer(),
  p = double(),
  p.adj = double(),
  p.adj.signif = character()
)
for (t in tasks) {
  ft_results <- host_task_counts %>%
    filter(task == t) %>%
    select(treatment, tasks_completed, no_task_count) %>%
    column_to_rownames(var = "treatment") %>%
    pairwise_fisher_test(p.adjust.method = "holm") %>%
    add_significance("p.adj")

  ft_results <- ft_results %>%
    mutate(
      task = rep(t, nrow(ft_results)),
      .keep = "all"
    ) %>%
    relocate(task)

  fisher_results <- rbind(
    fisher_results,
    ft_results
  )
}
# fisher_results
fisher_results <- as_tibble(fisher_results)
fisher_results <- fisher_results %>%
  mutate(
    task = as.factor(task),
    group1 = as.factor(group1),
    group2 = as.factor(group2)
  ) %>%
  group_by(
    task
  )
fisher_table <- kbl(fisher_results) %>% kable_styling()
save_kable(
  fisher_table,
  paste(plot_dir, "reps_with_task_hosts_stats.pdf", sep = "/")
)
```

### Symbionts

```{r}
reps_with_task_sym_plt <- ggplot(
  data = filter(tasks_completed, partner == "Symbiont"),
  aes(x = treatment, y = tasks_completed, color = treatment, fill = treatment)
) +
  geom_col(
    alpha = 0.5
  ) +
  scale_color_manual(
    name = "Treatment",
    values = viridis(4)
  ) +
  scale_fill_manual(
    name = "Treatment",
    values = viridis(4)
  ) +
  scale_x_discrete() +
  scale_y_continuous(
    limits = c(0, 31)
  ) +
  facet_wrap(~task) +
  labs(
    title = "Symbionts",
    y = "Replicates with task - Final Update",
    x = "Treatment"
  ) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(
      angle = 30,
      hjust = 1
    )
  )

ggsave(
  file = paste(plot_dir, "reps_with_task_sym_plt.pdf", sep = "/"),
  plot = reps_with_task_sym_plt
)
```

## Final number of different tasks done

### Hosts

```{r}
final_num_diff_tasks_hosts_plt <- ggplot(
  data = filter(num_tasks_done_by_rep_final, partner == "Host"),
  aes(x = treatment, y = tasks_completed, color = treatment)
) +
  geom_boxplot(
    alpha = 0.5,
    outlier.size = 1
  ) +
  scale_color_manual(
    name = "Treatment",
    values = viridis(4)
  ) +
  scale_y_continuous(
    limits = c(-0.1, 9.1),
    breaks = seq(0, 9)
  ) +
  labs(
    title = "Hosts",
    y = "Number of different tasks completed - Final Update",
    x = "Treatment"
  ) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(
      angle = 30,
      hjust = 1
    )
  )

ggsave(
  file = paste(plot_dir, "final_num_diff_tasks_hosts_plt.pdf", sep = "/"),
  plot = final_num_diff_tasks_hosts_plt
)
```

```{r}
kruskal.test(
  formula = tasks_completed ~ treatment,
  data = filter(tasks_done_final, partner == "Host")
)
```

### Symbionts

```{r}
final_num_diff_tasks_sym_plt <- ggplot(
  data = filter(num_tasks_done_by_rep_final, partner == "Symbiont"),
  aes(x = treatment, y = tasks_completed, color = treatment)
) +
  geom_boxplot(
    alpha = 0.5,
    outlier.size = 1
  ) +
  scale_color_manual(
    name = "Treatment",
    values = viridis(4)
  ) +
  scale_y_continuous(
    limits = c(-0.1, 9.1),
    breaks = seq(0, 9)
  ) +
  labs(
    title = "Symbionts",
    y = "Number of different tasks completed - Final Update",
    x = "Treatment"
  ) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(
      angle = 30,
      hjust = 1
    )
  )

ggsave(
  file = paste(plot_dir, "final_num_diff_tasks_sym_plt.pdf", sep = "/"),
  plot = final_num_diff_tasks_sym_plt
)
```

## Total distinct tasks completed over entire run

### Hosts

```{r}
num_diff_tasks_done_ever_hosts_plt <- ggplot(
  data = filter(num_tasks_done_by_rep_alltime, partner == "Host"),
  aes(x = treatment, y = tasks_completed_ever, color = treatment)
) +
  geom_boxplot(
    alpha = 0.5,
    outlier.size = 1
  ) +
  scale_color_manual(
    name = "Treatment",
    values = viridis(4)
  ) +
  scale_y_continuous(
    limits = c(-0.1, 9.1),
    breaks = seq(0, 9)
  ) +
  labs(
    title = "Hosts",
    y = "Number of different tasks completed - Entire run",
    x = "Treatment"
  ) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(
      angle = 30,
      hjust = 1
    )
  )

ggsave(
  file = paste(plot_dir, "num_diff_tasks_done_ever_hosts_plt.pdf", sep = "/"),
  plot = num_diff_tasks_done_ever_hosts_plt
)
```

### Symbionts

```{r}
num_diff_tasks_done_ever_sym_plt <- ggplot(
  data = filter(num_tasks_done_by_rep_alltime, partner == "Symbiont"),
  aes(x = treatment, y = tasks_completed_ever, color = treatment)
) +
  geom_boxplot(
    alpha = 0.5,
    outlier.size = 1
  ) +
  scale_color_manual(
    name = "Treatment",
    values = viridis(4)
  ) +
  scale_y_continuous(
    limits = c(-0.1, 9.1),
    breaks = seq(0, 9)
  ) +
  labs(
    title = "Symbionts",
    y = "Number of different tasks completed - Entire run",
    x = "Treatment"
  ) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(
      angle = 30,
      hjust = 1
    )
  )

ggsave(
  file = paste(plot_dir, "num_diff_tasks_done_ever_sym_plt.pdf", sep = "/"),
  plot = num_diff_tasks_done_ever_sym_plt
)
```

## Host task presence distributions

```{r}
# Build a lookup table for which runs have no symbiont tasks
syms_dead <- final_data %>%
  filter(partner == "Symbiont") %>%
  group_by(uid, rep, treatment) %>%
  summarize(
    total_tasks = sum(count)
  ) %>%
  group_by(uid, rep, treatment) %>%
  summarize(
    any_syms = total_tasks > 0
  ) %>%
  ungroup() %>%
  select(uid, any_syms)

# Pivot data wider (collapse partner rows into single row)
partner_match_final_data <- final_data %>%
  select(!c(task_completed, update)) %>%
  pivot_wider(
    names_from = partner,
    values_from = count
  ) %>%
  mutate(
    host_completed = Host >= task_completion_thresh,
    sym_completed = Symbiont >= task_completion_thresh
  ) %>%
  mutate(
    host_partner_match = host_completed & sym_completed
  )
# Add column indicating whether replicate has any symbionts by
# joining syms_dead lookup table with wider dataframe.
partner_match_final_data <- inner_join(
  x = syms_dead,
  y = partner_match_final_data,
  by = join_by(uid)
)

# Add factor column that indicates:
# - host_performs_mismatch_syms,
# - host_performs_match_syms,
# - host_performs_no_syms
# - no_host

partner_match_final_data <- partner_match_final_data %>%
  mutate(
    host_task_presence = case_when(
      host_completed & !any_syms ~ "no_syms",
      host_completed & sym_completed ~ "syms_match",
      host_completed & !sym_completed ~ "syms_mismatch",
      !host_completed ~ "none",
      .default = "unknown"
    )
  ) %>%
  mutate(
    host_task_presence = as.factor(host_task_presence)
  )
# Summarize counts of host_task_presence
host_task_presence_counts <- partner_match_final_data %>%
  group_by(treatment, task) %>%
  summarize(
    no_hosts = sum(host_task_presence == "none"),
    host_no_syms = sum(host_task_presence == "no_syms"),
    host_syms_match = sum(host_task_presence == "syms_match"),
    host_syms_mismatch = sum(host_task_presence == "syms_mismatch"),
    n = n()
  )

host_task_presence_counts_plt <- host_task_presence_counts %>%
  pivot_longer(
    !c(treatment, task),
    names_to = "host_task_presence",
    values_to = "count"
  ) %>%
  filter(
    host_task_presence %in% c(
      "host_no_syms",
      "host_syms_match",
      "host_syms_mismatch"
      # "no_hosts"
    )
  ) %>%
  ggplot(
    aes(
      x = treatment,
      y = count,
      fill = host_task_presence,
      color = host_task_presence
    )
  ) +
  geom_col() +
  facet_wrap(~task) +
  scale_fill_bright() +
  scale_color_bright() +
  labs(title = "Stress - Host")

ggsave(
  file = paste(plot_dir, "host_task_presence_counts_plt.pdf", sep = "/"),
  plot = host_task_presence_counts_plt,
  width = 10,
  height = 10
)
```

## Number of replicates where symbionts are extinct

```{r}
num_syms_extinct <- final_data %>%
  filter(partner == "Symbiont") %>%
  group_by(uid, rep, treatment) %>%
  summarize(
    total_tasks = sum(count)
  ) %>%
  group_by(uid, rep, treatment) %>%
  summarize(
    any_syms = total_tasks > 0
  )
  # ) %>%
  # ungroup() %>%
  # group_by(treatment) %>%
  # summarize(
  #   num_reps_syms_extinct = sum(any_syms == FALSE),
  #   num_reps = n()
  # )
```